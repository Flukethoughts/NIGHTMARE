###############################################################################
# Calibration Macros
###############################################################################

[gcode_macro PID_CALIBRATE_HOTEND]
description: PID tune the hotend at specified temperature
gcode:
    {% set temp = params.TEMP|default(230)|float %}
    MAYBE_HOME
    G0 X250 Y250 Z10 F18000
    PID_CALIBRATE HEATER=extruder TARGET={temp}

[gcode_macro PID_CALIBRATE_BED]
description: PID tune the bed at specified temperature
gcode:
    {% set temp = params.TEMP|default(60)|float %}
    MAYBE_HOME
    G0 X250 Y250 Z10 F18000
    PID_CALIBRATE HEATER=heater_bed TARGET={temp}

[gcode_macro G32]
description: Home all axes and level the bed (G28 + Z_TILT_ADJUST)
gcode:
    G28
    Z_TILT_ADJUST
    G28 Z

[gcode_macro GENERATE_SHAPER_GRAPHS]
description: Run input shaper test and generate graphs for X and Y axes
gcode:
    MAYBE_HOME
    SHAPER_CALIBRATE
    RESPOND MSG="Generating shaper graphs..."
    RUN_SHELL_COMMAND CMD=generate_shaper_graph

[gcode_shell_command generate_shaper_graph]
command: bash /home/pi/printer_data/config/scripts/generate_shaper_graph.sh
timeout: 90.
verbose: True

[gcode_macro MEASURE_COREXY_BELT_TENSION]
description: Measure belt tension via accelerometer and generate comparison graph
gcode:
    MAYBE_HOME
    G0 X250 Y250 Z50 F18000
    RESPOND MSG="Testing upper belt (A motor diagonal)..."
    TEST_RESONANCES AXIS=1,1 OUTPUT=raw_data NAME=belt-tension-upper
    RESPOND MSG="Testing lower belt (B motor diagonal)..."
    TEST_RESONANCES AXIS=1,-1 OUTPUT=raw_data NAME=belt-tension-lower
    RESPOND MSG="Generating comparison graph..."
    RUN_SHELL_COMMAND CMD=generate_belt_graph
    RESPOND MSG="Belt tension graph saved to input_shaper/ folder. View in Mainsail file browser."

[gcode_shell_command generate_belt_graph]
command: bash /home/pi/printer_data/config/scripts/generate_belt_graph.sh
timeout: 60.
verbose: True

[gcode_macro MEASURE_HYBRID_Y_BELT_TENSION]
description: Compare Y belt tension by testing at left and right X extremes. Hybrid CoreXY Y belts are independent cartesian belts that cannot be isolated via axis direction, so we bias the accelerometer by positioning the toolhead near each rail.
gcode:
    MAYBE_HOME
    G0 Z50 F3000
    # Test near LEFT Y rail (stepper_y side)
    RESPOND MSG="Testing Y resonance near LEFT rail (X=30)..."
    G0 X30 Y250 F18000
    G4 P500
    TEST_RESONANCES AXIS=Y OUTPUT=raw_data NAME=y-belt-left
    # Test near RIGHT Y rail (stepper_y1 side)
    RESPOND MSG="Testing Y resonance near RIGHT rail (X=470)..."
    G0 X470 Y250 F18000
    G4 P500
    TEST_RESONANCES AXIS=Y OUTPUT=raw_data NAME=y-belt-right
    # Return to center
    G0 X250 Y250 F18000
    RESPOND MSG="Generating Y belt comparison graph..."
    RUN_SHELL_COMMAND CMD=generate_y_belt_graph
    RESPOND MSG="Y belt tension graph saved. View in Mainsail file browser."

[gcode_shell_command generate_y_belt_graph]
command: bash /home/pi/printer_data/config/scripts/generate_y_belt_graph.sh
timeout: 60.
verbose: True

[gcode_macro TEST_SPEED]
description: Test max speed and acceleration. Usage: TEST_SPEED [SPEED=300] [ACCEL=6000] [ITERATIONS=10]
gcode:
    {% set speed = params.SPEED|default(300)|int %}
    {% set accel = params.ACCEL|default(6000)|int %}
    {% set iterations = params.ITERATIONS|default(10)|int %}

    MAYBE_HOME
    G90
    G0 Z10 F3000

    # Set test accel
    SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel}

    {% for i in range(iterations) %}
        G0 X10 Y10 F{speed * 60}
        G0 X490 Y490 F{speed * 60}
        G0 X10 Y490 F{speed * 60}
        G0 X490 Y10 F{speed * 60}
    {% endfor %}

    # Return to center
    G0 X250 Y250 F{speed * 60}

    # Restore defaults
    SET_VELOCITY_LIMIT VELOCITY=500 ACCEL=6000
    RESPOND MSG="Speed test complete: {speed}mm/s @ {accel}mm/s2 x {iterations} iterations"

[gcode_macro CALIBRATE_BEACON]
description: Calibrate Beacon probe contact and model
gcode:
    MAYBE_HOME
    G0 X250 Y250 F18000
    G0 Z5 F900
    RESPOND MSG="Starting Beacon calibration..."
    RESPOND MSG="Make sure the nozzle is clean and the bed is at room temperature."
    BEACON_AUTO_CALIBRATE

[gcode_macro PROBE_TEST]
description: Test probe accuracy at current position. Usage: PROBE_TEST [SAMPLES=10] [SPEED=5]
gcode:
    {% set samples = params.SAMPLES|default(10)|int %}
    {% set speed = params.SPEED|default(5)|float %}
    MAYBE_HOME
    G0 X250 Y250 F18000
    PROBE_ACCURACY SAMPLES={samples} PROBE_SPEED={speed}

[gcode_macro SET_CENTER_KINEMATIC_POSITION]
description: Set toolhead position to center without homing (for recovery/debugging)
gcode:
    SET_KINEMATIC_POSITION X=250 Y=250 Z=150

[gcode_macro COLD_PULL]
description: Cold pull procedure - heats, cools, then pulls filament to clean nozzle
gcode:
    {% set pull_temp = params.PULL_TEMP|default(90)|float %}
    {% set heat_temp = params.HEAT_TEMP|default(230)|float %}
    RESPOND MSG="Cold pull: heating to {heat_temp}C..."
    M109 S{heat_temp}
    RESPOND MSG="Push filament in manually, then wait..."
    G4 P5000
    RESPOND MSG="Cooling to {pull_temp}C - DO NOT PULL YET..."
    M104 S{pull_temp}
    TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={pull_temp + 2}
    RESPOND MSG="At {pull_temp}C - PULL FILAMENT NOW! Slow and steady."

[gcode_macro PA_TUNING]
description: Print pressure advance tuning pattern. Usage: PA_TUNING [START=0] [END=0.1] [STEP=0.005]
gcode:
    {% set start = params.START|default(0)|float %}
    {% set end_val = params.END|default(0.1)|float %}
    {% set step = params.STEP|default(0.005)|float %}
    SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY=1 ACCEL=500
    TUNING_TOWER COMMAND=SET_PRESSURE_ADVANCE PARAMETER=ADVANCE START={start} FACTOR={step} BAND=5
    RESPOND MSG="PA tuning tower active: {start} to ~{end_val}, step {step} per 5mm band"
    RESPOND MSG="Print a tall single-wall cube to measure. Check https://www.klipper3d.org/Pressure_Advance.html"

#--- Corner Test Macros (stress test / ringing assessment) -----------------

[gcode_macro CORNER_TEST_FAST]
description: Corner ringing test — 900mm/s, 10000mm/s2, 100 laps
gcode:
    G28
    G0 Z10 F3000
    M204 S10000
    {% for i in range(100) %}
    G0 X10 Y10 F54000
    G0 X490 Y10 F54000
    G0 X490 Y490 F54000
    G0 X10 Y490 F54000
    {% endfor %}
    M204 S6000
    G0 X250 Y250 F30000

[gcode_macro CORNER_TEST_SLOW]
description: Corner ringing test — 500mm/s, 5000mm/s2, 30 laps
gcode:
    G28
    G0 Z10 F3000
    M204 S5000
    {% for i in range(30) %}
    G0 X10 Y10 F30000
    G0 X490 Y10 F30000
    G0 X490 Y490 F30000
    G0 X10 Y490 F30000
    {% endfor %}
    M204 S6000
    G0 X250 Y250 F30000

[gcode_macro CORNER_TEST_MEDIUM]
description: Corner ringing test — 350mm/s, 4000mm/s2, 30 laps
gcode:
    G28
    G0 Z10 F3000
    M204 S4000
    {% for i in range(30) %}
    G0 X10 Y10 F21000
    G0 X490 Y10 F21000
    G0 X490 Y490 F21000
    G0 X10 Y490 F21000
    {% endfor %}
    M204 S6000
    G0 X250 Y250 F12000

[gcode_macro CORNER_TEST_CRAWL]
description: Corner ringing test — 200mm/s, 3000mm/s2, 10 laps
gcode:
    G28
    G0 Z10 F3000
    M204 S3000
    {% for i in range(10) %}
    G0 X10 Y10 F12000
    G0 X490 Y10 F12000
    G0 X490 Y490 F12000
    G0 X10 Y490 F12000
    {% endfor %}
    M204 S6000
    G0 X250 Y250 F12000
